{% extends 'base.html' %}

{% load static %}

{% block title %}
    Vendelia | {{ product.product_name }}
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <div class="product-detail-gallery">
        {% if product.photo1 %}
        <div class="product-detail-image-wrapper">
            <a href="{{ product.photo1.url }}" class="product-detail-image-link">
                <img src="{{ product.photo1.url }}" alt="{{ product.product_name }}">
            </a>
        </div>
        {% endif %}
        {% if product.photo2 %}
        <div class="product-detail-image-wrapper">
            <a href="{{ product.photo2.url }}" class="product-detail-image-link">
                <img src="{{ product.photo2.url }}" alt="{{ product.product_name }}">
            </a>
        </div>
        {% endif %}
        {% if product.photo3 %}
        <div class="product-detail-image-wrapper">
            <a href="{{ product.photo3.url }}" class="product-detail-image-link">
                <img src="{{ product.photo3.url }}" alt="{{ product.product_name }}">
            </a>
        </div>
        {% endif %}
    </div>
    
    

    <div class="product-detail-info-box">
        <p class="product-detail-category">Categoría: {{ product.category }}</p>

        <h1 class="product-detail-title">{{ product.product_name }}</h1>

        <div class="product-detail-price-buy-container">
            <input type="hidden" id="csrfToken" value="{{ csrf_token }}">
            <p class="product-detail-price">${{ product.price }}</p>
            {% if user.is_authenticated and not product.is_sold %}
            <button id="buyButton" class="product-detail-buy-button">Comprar</button>
            {% else %}
            <button class="product-detail-buy-button-disabled" disabled>Comprar</button>
            {% endif %}
        </div>
          

        <hr class="product-detail-info-box-separator" />
        

        <h2 class="product-detail-section-title">Descripción</h2>
        <p class="product-detail-description">{{ product.description }}</p>
    </div>
</div>


<div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <img class="product-detail-modal-content" id="modalImage">
</div>

<!-- Handles the modal image enlargement -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        const closeBtn = document.querySelector(".close");

        document.querySelectorAll(".product-detail-image-link").forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                modal.style.display = "block";
                modalImg.src = this.href;
            });
        });

        closeBtn.addEventListener("click", function () {
            modal.style.display = "none";
        });

        modal.addEventListener("click", function (e) {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        });
    });
</script>

<!-- Handles process of buying an item -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const buyButton = document.getElementById("buyButton");
        if (buyButton) {
            buyButton.addEventListener("click", function () {
                if (confirm("¿Estás seguro de que deseas comprar este producto?")) {
                    fetch("{% url 'buy_product' product.id %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": document.getElementById("csrfToken").value,
                            "Content-Type": "application/json",
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            if (data.success) {
                                // ✅ Redirect to "my_purchases" instead of reload
                                window.location.href = "{% url 'my_purchases' %}";
                            }
                        })
                        .catch(error => {
                            console.error("Error:", error);
                            alert("Error al procesar la compra.");
                        });
                }
            });
        }
    });
</script>
  
  
    
{% endblock %}